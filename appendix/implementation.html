<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation - Pikelet Language Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documentation for the Pikelet Language">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="stylesheet" href="../book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="../index.html">Pikelet</a></li><li><a href="../installation/index.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li><a href="../language/index.html"><strong aria-hidden="true">2.</strong> Language</a></li><li><ol class="section"><li><a href="../language/conditionals.html"><strong aria-hidden="true">2.1.</strong> Conditionals</a></li><li><a href="../language/records.html"><strong aria-hidden="true">2.2.</strong> Records</a></li><li><a href="../language/functions.html"><strong aria-hidden="true">2.3.</strong> Functions</a></li><li><a href="../language/type-inference.html"><strong aria-hidden="true">2.4.</strong> Type inference</a></li><li><a href="../language/types-of-types.html"><strong aria-hidden="true">2.5.</strong> Types of types</a></li></ol></li><li><a href="../appendix/index.html"><strong aria-hidden="true">3.</strong> Appendix</a></li><li><ol class="section"><li><a href="../appendix/design.html"><strong aria-hidden="true">3.1.</strong> Design</a></li><li><a href="../appendix/theory.html"><strong aria-hidden="true">3.2.</strong> Theory</a></li><li><a href="../appendix/implementation.html" class="active"><strong aria-hidden="true">3.3.</strong> Implementation</a></li><li><a href="../appendix/influences.html"><strong aria-hidden="true">3.4.</strong> Influences</a></li><li><a href="../appendix/references.html"><strong aria-hidden="true">3.5.</strong> References</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Pikelet Language Book</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#compiler-architecture" id="compiler-architecture"><h1>Compiler Architecture</h1></a>
<p>In order to create a separation of concerns, we break up our compiler into many
small stages, beginning with a source string, and ultimately ending up with
compiled machine code.</p>
<p>Below is a rough flow chart showing how source strings are currently lexed,
parsed, desugared, and type checked/elaborated:</p>
<pre><code class="language-bob">         .------------.
         |   String   |
         '------------'
                |
      syntax::parse::lexer
                |
                v
  .-----------------------------.
  | syntax::parse::lexer::Token |
  '-----------------------------'
                |
     syntax::parse::grammar
                |
                v
    .------------------------.
    | syntax::concrete::Term |
    '------------------------'
                |
   syntax::translation::desugar
                |
                v
      .-------------------.
      | syntax::raw::Term |
      '-------------------'
                |                        .---------------------.
    semantics::{check,infer} &lt;---------- | syntax::core::Value |
                |                        '---------------------'
                v                                    ^
      .--------------------.                         |
      | syntax::core::Term | - semantics::normalize -'
      '--------------------'
                |
                v
    TODO: compiler back end(s)
</code></pre>
<p>As you can see we have only built the front-end as of the time of writing. When
we begin to build out a <a href="https://github.com/pikelet-lang/pikelet/issues/9">compiler back end</a>,
more stages will be added after type checking and elaboration.</p>
<a class="header" href="#name-binding" id="name-binding"><h2>Name binding</h2></a>
<p>Name binding is a surprisingly challenging thing to implement in type checkers
and compilers. We use the <a href="https://github.com/brendanzab/moniker"><code>moniker</code> crate</a>
for this. Unfortunately this uses a quite slow method of name binding, and could
result in performance blowouts in the future. This is something to keep an eye on!</p>
<a class="header" href="#performance-considerations" id="performance-considerations"><h2>Performance considerations</h2></a>
<p>As you can see from the diagram above, this architecture leads to an
easy-to-reason about pipeline. It does however result in the creation of lots of
intermediate allocations of heap-allocated tree data structures that will
ultimately be discarded. This is quite similar to the problem we face with
iterators:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// 'internal' iteration
vec![1, 2, 3].map(|x| x * x).filter(|x| x &lt; 3)

// 'external' iteration
vec![1, 2, 3].iter().map(|x| x * x).filter(|x| x &lt; 3).collect()
#}</code></pre></pre>
<p>The first example, which uses 'internal' iteration allocates a new collection
after each operation, resulting in three allocated collections. We can improve
the performance however by using 'external' iteration - ie. returning a series
of chained iterator adaptors, that only perform the allocation on the call to
<code>collect</code>. This emulates the 'fusion' that languages like Haskell perform to
reduce intermediate allocations.</p>
<p>We could potentially get some fusion between the stages of our compiler by way
of the <a href="https://github.com/pikelet-lang/pikelet/issues/75">visitor pattern</a>.</p>
<a class="header" href="#support-for-interactive-development" id="support-for-interactive-development"><h2>Support for interactive development</h2></a>
<p>It would be interesting to see how Pikelet could be implemented using an
asynchronous, query-based architecture. This will become more important as the
demands of interactive development and incremental compilation become more
pressing. In this model we would have to think of compilation as less a pure
function from source code to machine code, and more as interacting with a
database. Perhaps a CQRS (Command-Query-Responsibility-Segregation) model would
be useful for this?</p>
<a class="header" href="#resources" id="resources"><h3>Resources</h3></a>
<ul>
<li><a href="https://rust-lang-nursery.github.io/rustc-guide/query.html">Queries: demand-driven compilation (Rustc Book)</a></li>
<li><a href="https://www.youtube.com/watch?v=wSdV1M7n4gQ">Anders Hejlsberg on Modern Compiler Construction (YouTube)</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../appendix/theory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../appendix/influences.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../appendix/theory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../appendix/influences.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../searchindex.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var path_to_root = "../";
        </script>
        
        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
